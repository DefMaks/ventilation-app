<ion-header class="defmaks-header">
  <ion-toolbar color="transparent">
    <ion-title class="defmaks-title">
      <ion-icon name="document-text-outline" class="title-icon"></ion-icon>
      DefMaks Ventilation
    </ion-title>
    <p class="defmaks-subtitle">Traitement facture</p>
  </ion-toolbar>
</ion-header>

<ion-content class="defmaks-content">
  <!-- File Upload Card -->
  <div class="defmaks-card defmaks-interactive">
    <ion-card-header>
      <ion-card-title class="defmaks-title">
        <ion-icon name="cloud-upload-outline" color="primary"></ion-icon>
        Importer un fichier PDF
      </ion-card-title>
      <ion-card-subtitle class="defmaks-subtitle">
        Sélectionnez votre relevé bancaire au format PDF
      </ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <div class="upload-area">
        <input
          type="file"
          (change)="onFileSelected($event)"
          accept="application/pdf"
          #fileInput
          class="file-input"
        />
        <div class="upload-placeholder" (click)="fileInput.click()">
          <ion-icon name="document-outline" size="large" color="medium"></ion-icon>
          <p class="defmaks-body">Cliquez pour sélectionner un fichier PDF</p>
          <p class="defmaks-caption">Formats acceptés: PDF uniquement</p>
        </div>
      </div>
      
      <ion-button 
        fill="clear" 
        size="small" 
        (click)="clearData()"
        *ngIf="transactions.length > 0"
        class="defmaks-button clear-button">
        <ion-icon name="refresh-outline" slot="start"></ion-icon>
        Effacer les données
      </ion-button>
    </ion-card-content>
  </div>

  <!-- Exchange Rate Info -->
  <div *ngIf="transactions.length > 0" class="defmaks-stats-card">
    <div class="exchange-rate-display">
      <div class="rate-info">
        <ion-icon name="swap-horizontal-outline" size="large"></ion-icon>
        <div class="rate-details">
          <h3>Taux de change appliqué</h3>
          <p class="rate-value">1 USD = {{ currentExchangeRate | number:'1.0-0' }} CDF</p>
        </div>
      </div>
      <ion-button 
        fill="clear" 
        size="small" 
        (click)="changeExchangeRate()"
        class="defmaks-button rate-button">
        <ion-icon name="create-outline" slot="start"></ion-icon>
        Modifier
      </ion-button>
    </div>
  </div>

  <!-- Processing Indicator -->
  <div *ngIf="isProcessing" class="defmaks-card processing-card">
    <ion-card-content>
      <div class="processing-content">
        <ion-spinner name="crescent" class="defmaks-spinner"></ion-spinner>
        <div class="processing-text">
          <h3 class="defmaks-title">Traitement en cours...</h3>
          <p class="defmaks-body">Extraction des données du PDF</p>
        </div>
      </div>
      <ion-progress-bar type="indeterminate" class="defmaks-progress"></ion-progress-bar>
    </ion-card-content>
  </div>

  <!-- Validation Errors -->
  <div *ngIf="validationErrors.length > 0" class="defmaks-card error-card">
    <ion-card-header>
      <ion-card-title class="error-title">
        <ion-icon name="warning-outline" color="warning"></ion-icon>
        Avertissements détectés
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="error-list">
        <div *ngFor="let error of validationErrors" class="error-item">
          <ion-icon name="alert-circle-outline" color="warning" size="small"></ion-icon>
          <span class="defmaks-body">{{ error }}</span>
        </div>
      </div>
    </ion-card-content>
  </div>

  <!-- Export Actions -->
  <div *ngIf="transactions.length > 0" class="export-section">
    <div class="defmaks-section-header">Actions d'export</div>
    
    <div class="export-buttons">
      <ion-button
        expand="block"
        color="success"
        (click)="exportToExcel()"
        class="defmaks-button export-button">
        <ion-icon name="document-outline" slot="start"></ion-icon>
        <div class="button-content">
          <span class="button-title">Créer Template Excel ONT</span>
          <span class="button-subtitle">Format officiel recommandé</span>
        </div>
      </ion-button>

      <ion-button
        expand="block"
        color="secondary"
        (click)="exportToExcelLegacy()"
        class="defmaks-button export-button">
        <ion-icon name="download-outline" slot="start"></ion-icon>
        <div class="button-content">
          <span class="button-title">Export Simple</span>
          <span class="button-subtitle">Format de compatibilité</span>
        </div>
      </ion-button>
    </div>
  </div>

  <!-- Template Update Section -->
  <div *ngIf="transactions.length > 0" class="defmaks-card">
    <ion-card-header>
      <ion-card-title class="defmaks-title">
        <ion-icon name="refresh-outline" color="tertiary"></ion-icon>
        Mettre à jour un template existant
      </ion-card-title>
      <ion-card-subtitle class="defmaks-subtitle">
        Importez un fichier Excel existant pour le mettre à jour
      </ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <div class="template-upload">
        <input
          type="file"
          (change)="onTemplateFileSelected($event)"
          accept=".xlsx,.xls"
          #templateInput
          class="file-input"
        />
        <div class="upload-placeholder template-placeholder" (click)="templateInput.click()">
          <ion-icon name="document-text-outline" size="large" color="tertiary"></ion-icon>
          <p class="defmaks-body">Sélectionner un fichier Excel</p>
          <p class="defmaks-caption">Formats: .xlsx, .xls</p>
        </div>
      </div>
    </ion-card-content>
  </div>

  <!-- Data Summary -->
  <div *ngIf="transactions.length > 0" class="defmaks-card">
    <ion-card-header>
      <ion-card-title class="defmaks-title">
        <ion-icon name="analytics-outline" color="primary"></ion-icon>
        Résumé des données ({{ transactions.length }} transactions)
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <!-- Summary by designation -->
      <div class="defmaks-section-header">Résumé par désignation</div>
      <div class="summary-grid">
        <div *ngFor="let summary of getSummaryByDesignation()" 
             class="summary-item defmaks-interactive"
             (click)="openTransactionQuickview(summary.designation)">
          <div class="summary-content">
            <h3 class="summary-title">{{ summary.designation }}</h3>
            <div class="summary-stats">
              <span class="transaction-count">{{ summary.count }} transaction(s)</span>
              <div class="amount-display">
                <strong class="cdf-amount defmaks-amount-positive">{{ summary.total | number:'1.2-2' }} CDF</strong>
                <small *ngIf="summary.totalUsd > 0" class="usd-amount">({{ summary.totalUsd | number:'1.2-2' }} USD)</small>
              </div>
            </div>
          </div>
          <div class="quickview-indicator">
            <ion-icon name="eye-outline" color="primary"></ion-icon>
            <span class="quickview-text">Voir détails</span>
          </div>
        </div>
      </div>

      <!-- Detailed transactions -->
      <ion-accordion-group class="defmaks-accordion">
        <ion-accordion value="details">
          <ion-item slot="header" class="accordion-header">
            <ion-icon name="list-outline" slot="start" color="primary"></ion-icon>
            <ion-label class="defmaks-title">Voir toutes les transactions</ion-label>
            <ion-icon name="chevron-down-outline" slot="end" color="medium"></ion-icon>
          </ion-item>
          <div slot="content" class="accordion-content">
            <div class="transaction-list">
              <div *ngFor="let t of transactions; let i = index" 
                   class="defmaks-transaction-item"
                   [class.suspicious-transaction]="isSuspiciousAmount(t.montant)">
                <div class="transaction-header">
                  <div class="transaction-info">
                    <h3 class="transaction-date">{{ t.date }}</h3>
                    <p class="transaction-designation" 
                       [class.full-designation]="isSuspiciousAmount(t.montant)">
                      {{ t.designation }}
                      <small *ngIf="isSuspiciousAmount(t.montant)" class="suspicious-note">
                        <ion-icon name="warning-outline" size="small"></ion-icon>
                        Montant suspect - Libellé complet affiché
                      </small>
                    </p>
                  </div>
                  <div class="transaction-badge">
                    <span class="defmaks-status-success">{{ i + 1 }}</span>
                    <ion-icon *ngIf="isSuspiciousAmount(t.montant)" 
                             name="warning" 
                             color="warning" 
                             class="suspicious-icon"></ion-icon>
                  </div>
                </div>
                
                <div class="transaction-amounts">
                  <div *ngIf="t.debit > 0" class="amount-row debit-row">
                    <span class="amount-label">Débit:</span>
                    <span class="amount-value defmaks-amount-negative">{{ t.debit | number:'1.2-2' }} CDF</span>
                  </div>
                  <div *ngIf="t.credit > 0" class="amount-row credit-row">
                    <span class="amount-label">Crédit:</span>
                    <span class="amount-value defmaks-amount-positive">{{ t.credit | number:'1.2-2' }} CDF</span>
                  </div>
                  <div class="amount-row net-row">
                    <span class="amount-label">Net:</span>
                    <strong [class]="t.montant >= 0 ? 'defmaks-amount-positive' : 'defmaks-amount-negative'">
                      {{ t.montant | number:'1.2-2' }} CDF
                    </strong>
                  </div>
                  
                  <!-- Enhanced original amount display for suspicious transactions -->
                  <div *ngIf="usdAmounts[i] && isSuspiciousAmount(t.montant)" class="original-amounts-section">
                    <div class="original-header">
                      <ion-icon name="swap-horizontal-outline" size="small"></ion-icon>
                      <span class="original-title">Montants originaux (USD)</span>
                    </div>
                    <div *ngIf="usdAmounts[i].debit > 0" class="amount-row original-row">
                      <span class="amount-label">Débit USD:</span>
                      <span class="usd-original">{{ usdAmounts[i].debit | number:'1.2-2' }} USD</span>
                    </div>
                    <div *ngIf="usdAmounts[i].credit > 0" class="amount-row original-row">
                      <span class="amount-label">Crédit USD:</span>
                      <span class="usd-original">{{ usdAmounts[i].credit | number:'1.2-2' }} USD</span>
                    </div>
                    <div class="amount-row original-row">
                      <span class="amount-label">Net USD:</span>
                      <strong class="usd-original">{{ usdAmounts[i].montant | number:'1.2-2' }} USD</strong>
                    </div>
                  </div>
                  
                  <!-- Regular original amount for non-suspicious transactions -->
                  <div *ngIf="usdAmounts[i] && !isSuspiciousAmount(t.montant)" class="amount-row original-row">
                    <span class="amount-label">Original:</span>
                    <small class="usd-original">{{ usdAmounts[i].montant | number:'1.2-2' }} USD</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ion-accordion>
      </ion-accordion-group>
    </ion-card-content>
  </div>
</ion-content>